Guia de correÃ§Ã£o â€“ erro 515 â€œStream Errored (restart required)â€ logo apÃ³s isNewLogin=true (Baileys)

============================================================
VISÃƒO GERAL
------------------------------------------------------------
â€¢ O QR Code Ã© lido e as credenciais sÃ£o gravadas, mas o handshake WebSocket com os
  servidores WhatsApp cai imediatamente com stream:error 515.
â€¢ Esse cÃ³digo costuma indicar versÃ£o de protocolo fora de sincronismo OU conexÃ£o
  WebSocket cortada pelo host (Replit costuma fechar sockets longâ€‘lived).
â€¢ O timeout subsequente no uploadPreKeys confirma que os pacotes nÃ£o chegam
  ao servidor.

============================================================
PASSO A PASSO DE CORREÃ‡ÃƒO
------------------------------------------------------------
1. **Use a versÃ£o exata do Web WhatsApp**
   Baileys precisa conversar no mesmo â€œversâ€ que o Web WhatsApp oficial.
   Adicione logo antes de criar o socket:

   ```ts
   import makeWASocket, { fetchLatestBaileysVersion } from '@whiskeysockets/baileys'

   const { version, isLatest } = await fetchLatestBaileysVersion()
   console.log('VersÃ£o WAWeb      :', version, 'isLatest?', isLatest)

   const sock = makeWASocket({
     version,                 // ðŸ‘ˆ alinha o protocolo
     auth: state,
     // ... resto das opÃ§Ãµes
   })
   ```

2. **Salve credenciais a cada atualizaÃ§Ã£o**
   Desligamentos abruptos podem corromper o par de chaves.
   ```ts
   sock.ev.on('creds.update', saveState)
   ```

3. **Aumente keepâ€‘alive e habilite ping interno**
   Replit tende a derrubar sockets ociosos depois de 30â€“60â€¯s.
   ```ts
   keepAliveIntervalMs: 15000,      // ping a cada 15â€¯s
   networkIdleTimeoutMs: 60000,     // considera inativo sÃ³ apÃ³s 60â€¯s
   ```

4. **Desative â€˜fireInitQueriesâ€™ na primeira conexÃ£o**
   Alguns aparelhos/dispositivos devolvem 515 se recebem initâ€‘queries muito cedo.
   Continue com `fireInitQueries: false` e sÃ³ dispare manualmente apÃ³s â€˜openâ€™:

   ```ts
   sock.ev.on('connection.update', ({ connection }) => {
     if (connection === 'open') {
       sock.sendPresenceUpdate('available')
     }
   })
   ```

5. **Reâ€‘tente automaticamente quando statusCode === 515**
   ```ts
   sock.ev.on('connection.update', ({ connection, lastDisconnect }) => {
     const code = (lastDisconnect?.error as any)?.output?.statusCode
     if (connection === 'close' && code === 515) {
       console.warn('Erro 515: reiniciando socket...')
       restartSocketAfterDelay(5000)
     }
   })
   ```

6. **Teste fora do Replit**
   Para eliminar dÃºvida de rede, execute localmente ou num VPS (DigitalOcean/Linode).
   Se funcionar fora do Replit, a causa Ã© a limitaÃ§Ã£o de WebSockets longa duraÃ§Ã£o
   da prÃ³pria plataforma.

7. **Habilite proxy HTTP/HTTPS (opcional)**
   Se a rede do Replit bloqueia as portas 443/HTTPS para websocketâ€‘upgrade,
   configure um proxy de saÃ­da:
   ```ts
   const sock = makeWASocket({
     proxyAgent: new HttpsProxyAgent('http://proxyhost:3128'),
     // ...
   })
   ```

8. **Atualize Baileys e Node**
   ```
   npm i @whiskeysockets/baileys@latest
   npx npm-check-updates -u
   npm install
   ```

============================================================
RESUMO DE CÃ“DIGO AJUSTADO
------------------------------------------------------------
```ts
import makeWASocket, {
  fetchLatestBaileysVersion,
  useMultiFileAuthState
} from '@whiskeysockets/baileys'

async function initSocket () {
  const { state, saveCreds } = await useMultiFileAuthState('auth')
  const { version } = await fetchLatestBaileysVersion()

  const sock = makeWASocket({
    version,
    auth: state,
    logger,
    browser: ['Replitâ€‘Bot', 'Chrome', '1.0.0'],
    connectTimeoutMs: 120000,
    defaultQueryTimeoutMs: 120000,
    keepAliveIntervalMs: 15000,
    networkIdleTimeoutMs: 60000,
    qrTimeout: 180000,
    fireInitQueries: false,
    shouldIgnoreJid: jid => jid.includes('@newsletter')
  })

  sock.ev.on('creds.update', saveCreds)

  sock.ev.on('connection.update', ({ connection, lastDisconnect, isNewLogin }) => {
    if (connection === 'open') {
      console.log('ðŸŸ¢ Conectado!')
    }
    if (connection === 'close') {
      const code = (lastDisconnect?.error as any)?.output?.statusCode
      if (code === 515) {
        console.warn('515 recebido â€“ reiniciando em 5â€¯sâ€¦')
        setTimeout(initSocket, 5000)
      }
    }
    if (isNewLogin) console.log('Novo login detectado âœ…')
  })
}

initSocket()
```

Salve este arquivo como **resolve_baileys_515_v3.txt** e envie para o Replit.
